#!/bin/bash
# shellcheck disable=2016,2162

# generate locales
sudo locale-gen

# https://wiki.archlinux.org/index.php/Limits.conf
# https://wiki.archlinux.org/index.php/Core_dump
sudo tee -a /etc/security/limits.conf >/dev/null <<END
# https://wiki.archlinux.org/index.php/Limits.conf#core
* soft    core       0           # Prevent corefiles from being generated by default.
* hard    core       unlimited   # Allow corefiles to be temporarily enabled.
END

# lutris: use system libretro cores
# https://github.com/lutris/lutris/issues/2444
ln -sfv "$XDG_CONFIG_HOME/retroarch/cores" "$XDG_DATA_HOME/lutris/runners/retroarch/cores"

# disable tty motd
touch "$HOME/.hushlogin"

# https://github.com/kakra/wine-proton/blob/rebase/proton_3.16/README.md#hints-to-32-bit-users-applies-also-to-syswow64
sudo sed -i "s/; shm-size-bytes.*/shm-size-bytes=1048576/" /etc/pulse/daemon.conf

# helper for "open with" firefox addon
mkdir "$XDG_DATA_HOME/open_with_addon"
cd "$XDG_DATA_HOME/open_with_addon" || exit 1
curl -O https://github.com/darktrojan/openwith/raw/master/webextension/native/open_with_linux.py
chmod u+x open_with_linux.py
./open_with_linux.py install

# fix distorted/crackling/robotized audio in discord and some games
# https://askubuntu.com/questions/1102738/crackling-static-in-discord-with-default-audio-output-port-pulseaudio
# https://www.reddit.com/r/discordapp/comments/7si7s3/linux_crackling_sound_in_application/
# https://wiki.archlinux.org/index.php/PulseAudio/Troubleshooting#Glitches,_skips_or_crackling
sudo sed -i "s|load-module module-udev-detect|load-module module-udev-detect tsched=0|g" /etc/pulse/default.pa

# https://wiki.archlinux.org/index.php/Bluetooth#Auto_power-on_after_boot
sudo sed -i "s|#AutoEnable=false|AutoEnable=true|g" /etc/bluetooth/main.conf

# set java version for multimc https://aur.archlinux.org/packages/multimc5/#pinned-700404
# https://github.com/MultiMC/MultiMC5/wiki/FAQ#not-the-right-java-version
# sudo archlinux-java status
#sudo archlinux-java set java-8-openjdk

# install some steam play tools
cd "$XDG_DATA_HOME/Steam/compatibilitytools.d" || exit 1
# https://github.com/dreamer/luxtorpeda
# TODO: package this
curl -L https://luxtorpeda.gitlab.io/luxtorpeda/master/luxtorpeda.tar.xz | tar xJf -
# https://github.com/dreamer/roberta
# TODO: package this
#curl -L https://github.com/dreamer/roberta/releases/download/v0.1.0/roberta.tar.xz | tar xJf -
# https://github.com/GloriousEggroll/proton-ge-custom
# TODO: package this
#curl -L https://github.com/GloriousEggroll/proton-ge-custom/releases/download/5.2-GE-1/Proton-5.2-GE-1.tar.gz | tar zxvf -

# copy vimix theme
[[ ! -d /boot/grub/themes/Vimix ]]; sudo cp -r /usr/share/grub/themes/Vimix /boot/grub/themes/Vimix

# psd
sudo tee /etc/sudoers.d/psd <<< "$USER ALL=(ALL) NOPASSWD: /usr/bin/psd-overlay-helper"

# relocate fontconfig cache to global dir until xorg is not run as user
# TODO: https://github.com/sddm/sddm/issues/246
sudo chmod 777 /var/cache/fontconfig
ln -sfv /var/cache/fontconfig "$XDG_CACHE_HOME/fontconfig_11"
ln -sfv /var/cache/fontconfig "$XDG_CACHE_HOME/fontconfig"

# aur packages
sudo install -o "$USER" -g "$USER" -d /var/cache/pacman/aur-pkg

# mpv scripts
ln -svf /usr/lib/mpv/mpris.so /usr/share/mpv/scripts/{pause-when-minimize,autodeint,autocrop,webm}.lua "$XDG_CONFIG_HOME/mpv/scripts"

# disk is slow
#balooctl config add excludeFolders /media/disk0 /media/disk2
# balooctl is broken and accepts only one argument
sed -i "s|exclude folders.*|exclude folders[\$e]=/media/disk0/,/media/disk1/,/media/disk2/|" "$HOME/.config/baloofilerc"

# snap
sudo snap set system refresh.retain=2